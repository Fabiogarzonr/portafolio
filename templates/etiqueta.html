<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vista de Etiqueta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; background: #f4f4f4; }
    .etiqueta {
      width: 9cm;
      height: 5.8cm;
      border: 2px solid black;
      background: white;
      display: flex;
      box-sizing: border-box;
      overflow: hidden;
      margin: 20px auto;
      page-break-inside: avoid;
    }
    .seccion-izquierda {
      flex: 2;
      padding: 4px;
      border-right: 2px solid black;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .proveedor { font-size: 9px; }
    .titulo-reactivo { font-size: 13px; font-weight: bold; }
    .preparacion, .advertencia, .fechas, .preparado { font-size: 9px; line-height: 1.1; }
    .advertencia { text-align: center; font-weight: bold; }
    .fechas {
      display: flex;
      justify-content: space-between;
      border-top: 1px solid black;
      padding-top: 2px;
      font-size: 9px;
      text-align: center;
    }
    .fechas div { flex: 1; }
    .seccion-derecha {
      flex: 1.2;
      padding: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }
    .pictogramas-grid {
      display: grid;
      grid-template-columns: repeat(2, 1.7cm);
      gap: 4px;
      justify-content: center;
    }
    .pictogramas-grid img { width: 1.7cm; height: 1.7cm; object-fit: contain; }
    .qr img { width: 55px; height: 55px; }
  </style>
</head>
<body class="container py-4">

  <h2 class="text-center mb-4">Vista Previa de Etiqueta</h2>

  <div id="preview"></div>

  <div class="mb-3 text-center">
    <label for="cantidad" class="form-label">Cantidad de etiquetas</label>
    <input type="number" id="cantidad" value="1" min="1" class="form-control w-25 mx-auto">
  </div>

  <div class="text-center mt-3">
    <button class="btn btn-danger" onclick="descargarPDF()">Descargar PDF</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;

    const ghsToFile = {
      "GHS01": "bomba.png",
      "GHS02": "inflamable.png",
      "GHS03": "comburente.png",
      "GHS04": "gas.png",
      "GHS05": "corrosivo.png",
      "GHS06": "toxico.png",
      "GHS07": "irritacion.png",
      "GHS08": "salud.png",
      "GHS09": "medioambiente.png",
      "NoAplica": "noaplica.png"
    };

    const datos = JSON.parse(localStorage.getItem("datosEtiqueta"));
    const preview = document.getElementById("preview");

    function construirEtiqueta() {
      return `
        <div class="etiqueta">
          <div class="seccion-izquierda">
            <div class="proveedor"><b>Proveedor:</b> ${datos.empresa} TEL: ${datos.telefono}</div>
            <div class="titulo-reactivo">${datos.reactivo}</div>
            <div class="preparacion"><b>Preparación:</b><br>${datos.preparacion}</div>
            <div class="advertencia">⚠️ ADVERTENCIA:<br>${datos.frases.join("<br>")}</div>
            <div class="fechas">
              <div><b>Preparado:</b><br>${datos.fechaPrep}</div>
              <div><b>Vence:</b><br>${datos.fechaVenc}</div>
            </div>
            <div class="preparado"><b>Preparado por:</b> ${datos.analista}</div>
          </div>
          <div class="seccion-derecha">
            <div class="pictogramas">
              <b>Pictogramas</b>
              <div class="pictogramas-grid">
                ${datos.pictogramas.map(p => `<img src="/imagenes/${ghsToFile[p] || 'noaplica.png'}" alt="${p}">`).join("")}
              </div>
            </div>
            <div class="qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=55x55&data=${encodeURIComponent(datos.reactivo)}" alt="QR"></div>
          </div>
        </div>`;
    }

    preview.innerHTML = construirEtiqueta();

    async function descargarPDF() {
      const cantidad = parseInt(document.getElementById("cantidad").value) || 1;
      const etiquetaOriginal = document.getElementById("preview").firstElementChild;
      if (!etiquetaOriginal) {
        alert("⚠️ No hay etiqueta generada");
        return;
      }

      
      const canvas = await html2canvas(etiquetaOriginal, { scale: 3, useCORS: true });
      const imgData = canvas.toDataURL("image/png");

      const pdf = new jsPDF("p", "pt", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();


      const etiquetaWidth = 250;
      const etiquetaHeight = 160;
      const margin = 20;

      let x = margin;
      let y = margin;

      for (let i = 0; i < cantidad; i++) {

        if (x + etiquetaWidth > pageWidth - margin) {
          x = margin;
          y += etiquetaHeight + 15;
        }
        if (y + etiquetaHeight > pageHeight - margin) {
          pdf.addPage();
          x = margin;
          y = margin;
        }

        pdf.addImage(imgData, "PNG", x, y, etiquetaWidth, etiquetaHeight);


        x += etiquetaWidth + 15;
      }

      pdf.save("etiquetas.pdf");
    }
  </script>
</body>
</html>
